# COCi 리뉴얼
[COCi-Movie-Crawler github](https://github.com/sw-corini/COCi-Movie-Crawler)

---

## 1. Crawler 다시 만들기

### - 2019.05.06
 중요한 것은 *Crawler*를 다시 만드는 것이다. 지금 1차 버전에서는 매일 0시마다 내 윈도우 데스크탑에서 *forever*로 돌고 있다. 잘 돌아가고 있지만 문제는 그 윈도우 데스크탑이 가끔씩 집에 상주하시는 고양님의 터치로 꺼질 때가 있다는 것. 그때마다 수동으로 다시 켜긴 했지만 요즘 같은 시대에 개발자로 밥 벌어먹고 살면서 이게 뭐하는 짓인가 싶었다. 그래서 사실 리뉴얼을 할 것이 아니라해도 이 망할 크롤러는 손을 봤어야 했다.

 *AWS 서비스*를 이용해보기로 했다. 그리고 기존 데스크탑의 크롤러가 돌고나서 영화 정보를 업데이트하는 firestore도 걷어내고 AWS에 통합하기로 했다. 사실 이전에 서버리스 람다를 이용해서 해보려다 바쁜 일에 치이고 헤매면서 중도 포기를 했었다. 그러던 와중에 리뉴얼을 앞두고 AWS cloud9을 알게되었고 그래서 진행중인 COCi new Crawler는 cloud9+lambda+SQS+dynamoDB+cloudWatch 조합이 될 것 같다.

### - 2019.05.20
 이것저것 할 일도 많고 바빠서 가끔씩 들여다 보기만 하다가 오늘에야 진행상황을 정리해둔다. 5월 6일부터 진행 시작했던 소스가 너무 이런 저런 시도를 많이 해보다 엉망진창이 되어 이참에 오픈소스로 다시 작업을 하려고 깃을 새로 파서 작업하고 있다. 
 
  우선 오늘까지 완료된 사항을 정리하자면 다음과 같다.
1. cloud9(싱가포르 리전)에 lambda 함수 생성
2. 네이버 개봉예정작 목록에서 영화 코드를 긁어 SQS 대기열에 메시지 추가
3. 텔레그램 채널에 개봉예정작 SQS 대기열 등록 완료 메시지 출력
4. SQS 대기열에서 메시지 읽기 (코드)
5. 읽어들인 코드로 영화 상세 정보 긁어오기

 아직까지는 크게 거슬리는 소스 없이 진행되고 있다. 이제 내일은 긁어온 영화 상세 정보를 dynamoDB에 등록하는 작업을 완료할 계획이다.

### - 2019.05.21
 오늘은 긁어온 영화 데이터를 개봉예정작 코드 테이블과 영화 테이블에 저장하는 작업을 했다. 아직 dynamoDB에 대한 이해도가 많이 부족해서 하나하나 작업할 때마다 구글에서 열심히 헤엄치고 있다. 이렇게 또 콜백지옥을 만들어냈군. 어쨌거나 완료된 함수들을 서울 리전 람다에 배포하고 CloudWatch에 규칙을 추가해줬다. 
 제발 문제 없이 잘 돌아줘 ㅠㅠ
 
### - 2019.05.22
 크롤러는 잘 돌고 있다. 이쯤에서 다시 한 번 정리를 해보자면,
 
 1. cloud9으로 만든 lambda함수가 네이버 개봉예정작 목록에서 네이버 영화 코드를 긁는다.
 2. 긁어들인 코드를 SQS 대기열에 등록한다.
 3. colud9으로 만든 lambda함수가 SQS 대기열에 쌓인 코드들을 읽어들인다.
 4. 읽어들인 코드로 네이버 영화 정보를 긁어 comming_soon_movies, movies 테이블에 각 정보를 등록한다.
 
 여기까지 내가 의도한 데이터들을 잘 수집했고 제법 만족스러워서 이제 UI를 잡자 하고 sketch를 켜서 디자인을 하던 중에 원래 넣으려고 했던 추가기능이 번뜩 생각났다. 
 
아 망할, 이래서 기획서 정리를 잘 해놨어야했는데 매번 이런다. 어쨌거나 그 추가기능을 위해서는 영화인에 대한 정보도 긁을 필요가 있었다.
 그런데 영화인 정보도 긁자니 이건 영화개봉예정일 알림서비스가 인데 알림을 주기 위해 쌓아놓는 데이터가 너무 많다. 배보다 배꼽이 점점 더 커지고 있었다. 사실 영화개봉예정작이 api만 있었으면 다 영화 api로 해결할 수 있는 것들인데 네이버영화 정보를 긁다보니 그게 안된다. 그래서 직접 다 긁어들인건데 계속 네이버의 데이터를 훔치는 기분이 들어 찝찝하기도 하고 해서 그냥 노가다로라도 내가 api 속 영화 코드와 네이버 영화 코드를 매칭시켜주기로 했다.
 
  그렇다면 추후 크롤러 관련 작업 계획은,
-   [x] movies 테이블을 제거한다. (이틀동안 열심히 모은 내 데이터 안녕...)
-   [x] SQS 대기열 메시지를 읽어들이는 함수 삭제. (열심히 작업한 내 함수야 안녕...)
-   [x] 매칭 정보를 등록할 movie_codes 테이블 생성
-   [ ] 네이버 개봉예정작 목록에서 긁어들인 네이버 영화 코드를 comming_soon_movies 테이블에 바로 등록.
-   [ ] movie_codes 테이블에 개봉예정작 네이버 영화 코드 업데이트

 여기서 문제는 어떤 영화 api에 매칭할 것이냐인데 이건 좀 더 고민을 해봐야할 것 같다. 퀄리티가 좋은 api는 다 외국 것인데 외국 api를 쓰면 영화 제목이나 정보들도 다 영어영어해지니까... 서비스 만들고 있는 나조차도 영어유치원 입뺀 실력이라 안 될 것 같은데 그 퀄리티는 또 포기하기 아쉽고...그렇다면 국내 api와 외국api를 같이 쓰는 게 더 나을지. 후 이건 좀 더 생각해보고 일단 얼른 크롤러 수정하고 코드를 매칭시킬 관리자페이지를 구상해야겠다.
  
